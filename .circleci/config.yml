---
version: 2.1

#
# CircleCI executors
#
executors:
  python-image:
    docker:
      - image: python:3.7
      - image: postgres:12.5
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb


#
# CircleCI commands
#
commands:
  setup-python-image-command:
    description: "steps to set up python-image executor"
    steps:
      - run:
          name: Install libraries
          command: |
            apt-get update -y \
                && apt-get install -y build-essential yamllint shellcheck jq
      - run:
          name: Set up the environment
          command: |
            pip install --no-cache-dir --force-reinstall -r "./ci/requirements.txt"

#
# jobs
#
jobs:
  unit-tests:
    executor: python-image
    steps:
      - checkout
      - setup-python-image-command
      - run:
          name: Validate bash scripts
          command: |
            bash ./ci/lint_bash.sh
      - run:
          name: Validate YAML files
          command: |
            bash ./ci/lint_yaml.sh
      - run:
          name: Run tox
          command: |
            tox

#
# Workflows
#
workflows:
  test:
    jobs:
      - unit-tests:
          filters:
            branches:
              only: /.*/
            tags:
              only: /.*/
      - integration-tests-postgres:
          filters:
            branches:
              only: /.*/
            tags:
              only: /.*/
