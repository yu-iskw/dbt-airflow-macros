---
version: 2.1

#
# CircleCI executors
#
executors:
  python-image:
    docker:
      - image: python:3.8
  postgres-image:
    docker:
      - image: postgres:9.6
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb


#
# CircleCI commands
#
commands:
  setup-python-image-command:
    description: "steps to set up python-image executor"
    steps:
      - run:
          name: Install libraries
          command: |
            apt-get update -y \
                && apt-get install -y build-essential yamllint shellcheck jq
      - run:
          name: Set up the environment
          command: bash ./ci/install_python_modules.sh
  setup-postgres-image-command:
    description: "steps to set up postgres-image executor"
    steps:
      - run:
          name: Install libraries
          command: |
            apt-get update -y \
                && apt-get install -y git gcc build-essential libbz2-dev libdb-dev \
                       libreadline-dev libffi-dev libgdbm-dev liblzma-dev \
                       libncursesw5-dev libsqlite3-dev libssl-dev \
                       zlib1g-dev uuid-dev tk-dev curl wget
      - run:
          name: Install pyenv
          command: |
            curl -L https://github.com/pyenv/pyenv-installer/raw/master/bin/pyenv-installer | bash
            echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
            echo 'export PATH="${HOME}/.pyenv/bin:$PATH"' >> ~/.bashrc
            echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bashrc
            source ~/.bashrc


#
# jobs
#
jobs:
  unit-tests:
    executor: python-image
    steps:
      - checkout
      - setup-python-image-command
      - run:
          name: Validate bash scripts
          command: |
            bash ./ci/lint_bash.sh
      - run:
          name: Validate YAML files
          command: |
            bash ./ci/lint_yaml.sh
      # TODO execute the integration test
  integration-tests-postgres:
    executor: postgres-image
    steps:
      - checkout
      - setup-postgres-image-command
      - run:
          name: test on python 3.7
          command: |
            whoami
            cat ~/.bashrc
            echo "$PATH"

            # Set up the python environment
            pyenv install 3.7
            pyenv global 3.7
            bash ./ci/install_python_modules.sh
            # Run tests
            cd integration_tests/postgres
            bash run_tests.sh

#
# Workflows
#
workflows:
  test:
    jobs:
      - unit-tests:
          filters:
            branches:
              only: /.*/
            tags:
              only: /.*/
      - integration-tests-postgres:
          filters:
            branches:
              only: /.*/
            tags:
              only: /.*/
