---
version: 2.1

#
# CircleCI executors
#
executors:
  python-image:
    docker:
      - image: python:3.8
  postgres-image:
    docker:
      - image: postgres:9.6
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb


#
# CircleCI commands
#
commands:
  setup-python-image-command:
    description: "steps to set up python-image executor"
    steps:
      - run:
          name: Install libraries
          command: |
            apt-get update -y \
                && apt-get install -y build-essential yamllint shellcheck jq
      - run:
          name: Set up the environment
          command: bash ./ci/install_python_modules.sh
  setup-postgres-image-command:
    description: "steps to set up postgres-image executor"
    steps:
      - run:
          name: Install libraries
          command: |
            apt-get update -y \
                && apt-get install -y git build-essential libssl-dev zlib1g-dev libbz2-dev \
                   libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
                   xz-utils tk-dev libffi-dev liblzma-dev
      - run:
          name: Install pyenv
          command: bash ./ci/install_pyenv.sh
      - run:
          name: Set up the environment
          command: bash ./ci/install_python_modules.sh


#
# jobs
#
jobs:
  unit-tests:
    executor: python-image
    steps:
      - checkout
      - setup-python-image-command
      - run:
          name: Validate bash scripts
          command: |
            bash ./ci/lint_bash.sh
      - run:
          name: Validate YAML files
          command: |
            bash ./ci/lint_yaml.sh
      # TODO execute the integration test
  integration-tests-postgres:
    executor: postgres-image
    steps:
      - checkout
      - setup-postgres-image-command
      - run:
          name: test on python 3.7
          command: |
            pyenv install 3.7
            pyenv global 3.7
            cd integration_tests/postgres
            bash run_tests.sh

#
# Workflows
#
workflows:
  test:
    jobs:
      - unit-tests:
          filters:
            branches:
              only: /.*/
            tags:
              only: /.*/
      - integration-tests-postgres:
          filters:
            branches:
              only: /.*/
            tags:
              only: /.*/
